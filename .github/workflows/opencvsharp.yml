name: Build-OpenCvSharp

on:
  #push:
  #  branches: 
  #    - main
  #  paths: 
  #    - .github/workflows/opencvsharp.yml
  #    - 'eng/opencvsharp.patch'
  workflow_dispatch:

env:
  OPENCVSHARP_VERSION: 4.11.0.20250507

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.runs-on }}
    defaults:
      run:
        shell: bash

    strategy:
      matrix:
        include:
        - { os: ubuntu.24.04, arch: x64,   runs-on: ubuntu-24.04 }
        - { os: ubuntu.24.04, arch: arm64, runs-on: ubuntu-24.04-arm }
        - { os: osx,          arch: x64,   runs-on: macos-14 }
        - { os: osx,          arch: arm64, runs-on: macos-14 }
        - { os: win,          arch: x64,   runs-on: windows-2022 }
        - { os: win,          arch: arm64, runs-on: windows-11-arm }

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download OpenCV Artifacts
      env:  
        GH_TOKEN: ${{ github.token }}  
      run: |  
        echo "Fetching latest run of opencv.yml on branch ${{ github.ref_name }}"  
        RUN_ID=$(gh run list -R ${{ github.repository }} --workflow=opencv.yml --branch=${{ github.ref_name }} --status=success --limit=1 --json databaseId | jq -r '.[0].databaseId')  
        echo "Latest opencv run ID: $RUN_ID"  
          
        echo "Downloading artifact 'opencv' from run ${RUN_ID}"  
        gh run download -R ${{ github.repository }} $RUN_ID --name opencv-${{ matrix.os }}-${{ matrix.arch }} --dir opencv

        echo "::group::OpenCV Artifacts"
        ls -lR opencv
        echo "::endgroup::"

    - name: Checkout OpenCvSharp
      uses: actions/checkout@v4
      with: 
        repository: shimat/opencvsharp
        ref: ${{ env.OPENCVSHARP_VERSION }}
        path: opencvsharp

    - name: Apply Patches
      run: |
        cd opencvsharp
        git apply --ignore-whitespace ../eng/opencvsharp.patch

    - name: Install Dependencies
      run: |
        if [[ "${{ matrix.os }}" =~ ^ubuntu ]]; then
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config
        fi

    - name: Configure OpenCvSharp
      run: |
        set -eux

        set --
        OpenCV_DIR="${{ github.workspace }}/opencv/lib/cmake/opencv4"

        if [[ "${{ matrix.os }}" =~ ^win ]]; then
          OpenCV_DIR="${{ github.workspace }}/opencv/${{ matrix.arch }}/vc17/staticlib"
          if [[ "${{ matrix.arch }}" == "x86" ]]; then
            set -- "$@" -A Win32
          elif [[ "${{ matrix.arch }}" == "arm64" ]]; then
            set -- "$@" -A ARM64
          else
            set -- "$@" -A x64
          fi
        fi
        
        # Recreate FFmpeg directory structure for Linux builds
        # OpenCV CMake config has hardcoded paths to where FFmpeg was built
        if [[ "${{ matrix.os }}" =~ ^ubuntu ]]; then
          FFMPEG_LIB_DIR="${{ github.workspace }}/opencv/lib/ffmpeg"
          if [[ -d "$FFMPEG_LIB_DIR" ]]; then
            echo "FFmpeg libraries found at: $FFMPEG_LIB_DIR"
            ls -la "$FFMPEG_LIB_DIR"
            # Recreate the build-time path structure
            mkdir -p ${{ github.workspace }}/ffmpeg-install/lib
            cp -v $FFMPEG_LIB_DIR/*.a ${{ github.workspace }}/ffmpeg-install/lib/
            echo "FFmpeg libraries copied to: ${{ github.workspace }}/ffmpeg-install/lib"
            ls -la ${{ github.workspace }}/ffmpeg-install/lib
          else
            echo "Warning: FFmpeg libraries not found at $FFMPEG_LIB_DIR"
          fi
        fi

        cd opencvsharp && mkdir build && cd build
        cmake \
          -D CMAKE_INSTALL_PREFIX="${{ github.workspace }}/opencvsharp/build" \
          -D OpenCV_DIR="$OpenCV_DIR" \
          "$@" \
          ../src

    - name: Build OpenCvSharp
      run: |
        set -eux
        cd opencvsharp/build
        if [[ "${{ matrix.os }}" =~ ^win ]]; then
          cmake --build . --parallel --config Release
        else
          make -j$(nproc)
        fi

    - name: Strip OpenCvSharpExtern
      run: |
        set -eux
        cd opencvsharp/build
        
        if [[ "${{ matrix.os }}" =~ ^win ]]; then
          BIN="OpenCvSharpExtern/Release/OpenCvSharpExtern.dll"
          llvm-objcopy --strip-all "$BIN"
        elif [[ "${{ matrix.os }}" =~ ^osx ]]; then
          BIN="OpenCvSharpExtern/libOpenCvSharpExtern.dylib"
          strip -x "$BIN"
        else  # Linux
          BIN="OpenCvSharpExtern/libOpenCvSharpExtern.so"
          strip --strip-unneeded "$BIN"
        fi

        echo "Size after strip:"
        du -h "$BIN"

    - name: Show OpenCvSharp Artifacts
      run: |
        cd opencvsharp/build
        echo "::group::OpenCvSharp Artifacts"
        ls -lR
        echo "::endgroup::"

        case "${{ matrix.os }}" in
          win)
            echo "Can't show dependencies for Windows DLLs"
            ;;
          osx*)
            otool -L OpenCvSharpExtern/libOpenCvSharpExtern.dylib
            ;;
          *) # Linux
            ldd OpenCvSharpExtern/libOpenCvSharpExtern.so
            ;;
        esac

    - name: Make artifacts
      run: |
        mkdir artifacts && cd artifacts && mkdir lib test
        if [[ "${{ matrix.os }}" =~ ^win ]]; then
          cp -r ../opencvsharp/build/OpenCvSharpExtern/Release/OpenCvSharpExtern.* ./lib
          # Include OpenCV FFmpeg runtime DLL(s) so file-video decoding works on target machines.
          if [[ -d ../opencv/ffmpeg ]]; then
            cp -v ../opencv/ffmpeg/opencv_videoio_ffmpeg*.dll ./lib/ || true
          else
            echo "No ../opencv/ffmpeg directory found; skipping FFmpeg runtime DLL copy."
          fi
        else
          cp -r ../opencvsharp/build/OpenCvSharpExtern/libOpenCvSharpExtern.* ./lib
        fi
        ls -lR

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: opencvsharp-${{ matrix.os }}-${{ matrix.arch }}
        path: artifacts
